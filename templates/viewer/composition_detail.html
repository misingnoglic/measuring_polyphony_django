{% extends "../base.html" %}

{% block title %}{{ object }}{% endblock %}
{% block head %}
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <style>
        #image-map {
          width: 100%;
          height: 300px;
          border: 1px solid #ccc;
          margin-bottom: 10px;
        }
    </style>
    <script src="http://www.verovio.org/javascript/develop/verovio-toolkit.js" type="text/javascript" ></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" type="text/javascript" ></script>

{% endblock %}

{% block content %}
    <section id="main">
        <div class="inner">
            <header>
                <h2>{{ object.fullname }}</h2>
            </header>
<h3>{{ object.composerfull }}</h3>
<b>Primary Source for this transcription</b>
<br>
            <b>{{ object.main_source }}</b>
{% if folios %}
, fol(s). {% for folio in folios %}{{ folio.folio_number }} {{ forloop.last|yesno:",&#44;"|safe }} {% endfor %}
    {% comment %} This weird syntax is for getting rid of the trailing comma{% endcomment %}
{% endif %}
<br>
{% if object.main_source.diamm_source %}
    <a href="{{ object.main_source.diamm_source }} " target="_blank">Information about source</a>
    <br>
{% endif %}
{% if object.main_source.iiif_manifest %}
    <a href="{% url 'composition-iiif' object.pk %}" target="_blank">Manuscript Image of Source</a>
    <br>
{% endif %}

{% if conc_sources %}
    <b>Concordant Sources</b>
    <br>
{% for source in conc_sources %}
    {{ source.source }}{{ forloop.last|yesno:",&#44;"|safe }}
{% endfor %}
</ul>
    <br>
{% endif %}

<b>Edition(s)</b><br>
            {{ object.edition }}
<br>
            <b>Playback</b><br>

            <a href="#" onClick="MIDIjs.play('{% url 'composition-midi' object.pk %}');">Play MIDI</a><br>
            <a href="#" onClick="MIDIjs.stop();">Stop MIDI Playback</a><br>

<b>Downloads</b>
<ul style="list-style: none; padding: 0; margin: 0">
    {% if object.mens_mei_file %}
        <a href="{{ object.mens_mei_file.url }}"><li>Mensural MEI</li></a>
        <a href="{% url 'composition-svg-mens' object.pk %}" target="_blank"><li>SVG for Score</li></a>
    {% endif %}

    {% if object.cmn_mei_file %}
        <a href="{{ object.cmn_mei_file.url }}"><li>Common MEI</li></a>
        <a href="{% url 'composition-midi' object.pk %}" target="_blank"><li>MIDI for Score</li></a>

    {% endif %}


</ul>
    <section id="content">
        <b>Mensural MEI File</b>
    <div>
        <!--<img src="{% url 'composition-svg-mens' object.pk %}"> -->
        <div id="image-map"></div>
    </div>
    </section>

            <div id="svg_output"/>
        </div>




    </section>

    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script>
    // Using leaflet.js to pan and zoom a big image.
    // Code from: http://kempe.net/blog/2014/06/14/leaflet-pan-zoom-image.html
    // create the slippy map
    var map = L.map('image-map', {
      minZoom: 0.5,
      maxZoom: 3,
      center: [0, 0],
      zoom: 0.5,
      crs: L.CRS.Simple
    });
    // dimensions of the image - modified for the SVG
    var w = 16076,
        h = 837,
        url = '{% url 'composition-svg-mens' object.pk %}';
    // calculate the edges of the image, in coordinate space
    var southWest = map.unproject([0, h], map.getMaxZoom()-1);
    var northEast = map.unproject([w, 0], map.getMaxZoom()-1);
    var bounds = new L.LatLngBounds(southWest, northEast);
    // add the image overlay,
    // so that it covers the entire map
    L.imageOverlay(url, bounds).addTo(map);
    // tell leaflet that the map is exactly as big as the image
    map.setMaxBounds(bounds);
    </script>

            <script type="text/javascript">

            ///////////////////////////
            /* Create the vrvToolkit */
            ///////////////////////////
            var vrvToolkit = new verovio.toolkit();
            options = {
                pageHeight: 2100,
                pageWidth: 3000,
                ignoreLayout: 1,
                border: 100,
                scale: 50
            };
            vrvToolkit.setOptions(options)

            ////////////////////////////////////
            /* Load the file using a HTTP GET */
            ////////////////////////////////////
            $.ajax({
                url: "{{ object.cmn_mei_file.url }}"
                , dataType: "text"
                , success: function(data) {
                    var svg = vrvToolkit.renderData(data);
                    $("#svg_output").html(svg);
                }
            });
        </script>

{% endblock %}